# Node.js를 루트가 아닌 사용자로써 실행하라

### 한 문단 설명

'최소 권한의 원칙'에 의해 유저/프로세스는 오직 필요한 정보와 자원에 대해서만 접근 가능해야 한다. 공격자에게 루트 접근권한을 주는 것은 다른 서버로 라우팅 트래픽을 선사하는 해악의 신세계를 경함하게 할것이다. 실제로는, 대부분 Node.js 앱들은 루트 액세스가 필요 없으며, 실행에 있어 그러한 특권(privileges)을 필요로 하지 않는다. 그러나, 루트 사용을 요하는 두 가지 시나리오가 존재한다.

- 우선 포트(예. port 80)에 대한 액세스를 얻기 위해 Node.js는 반드시 루트로 실행되어야 한다.
- 도커 컨테이너들은 기본적으로(by default) 루트로 실행된다(!). Node.js 웹 애플리케이션이 비-우선 포트를 리슨하고 nginx와 같은 리버스-프록시에 의존하여 포트번호 80번으로 부터 유입되는 트래픽을 리다이렉트하는 방법이 권장된다.
  도커 이미지를 빌드할 때, 고도로 보안된 앱은 반드시 대체 비-루트 유저로 컨테이너를 실행하여야 한다. 대부분 도커 클러스터들(예. 스웜, 쿠버네티스) 보안 문장을 선언형으로 세팅하도록 허용한다.

### 코드 예시 - 도커 이미지를 비-루트 로 빌드한다. Building a Docker image as non-root

```dockerfile
FROM node:latest
COPY package.json .
RUN npm install
COPY . .
EXPOSE 3000
USER node
CMD ["node", "server.js"]
```

<br/><br/>

### 블로그 인용: "기본적으로, 도커는 컨테이너를 루트로 실행한다."

[eyalzek](https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#non-root-user)의 '도커-노드 저장소'로 부터:

> 기본적으로, 도커는 컨테이너를 루트로 실행하는데 이는 내부 컨테이너가 보안상 문제를 제기할 수 있는 부분이다. 너는 언제든 가능하다면 컨테이너를 비유저로 실행하고 싶을 것이다. 노드 이미지들은 노드 유저에게 그러한 목적의 달성을 제공한다(비유저로 실행할 수 있는 목적). 도커 이미지는 그리고 나선 다음과 같은 방법으로 실행될 수 있다: "-u 'node'"

<br/><br/>

### 블로그 인용: "공격자가 너의 머신에 대해 완전한 지배권을 획득할 것이다."

[Olivier Lalonde](http://syskall.com/dont-run-node-dot-js-as-root/)의 'Node.js를 루트로 실행하지 마라' 블로그로 부터:

> 사실, 너가 너의 서버를 루트로 사용하고 있고, 이것이 코드의 취약성으로 인해 해킹당하면, 공격자는 너의 머신에 대한 완전한 지배권을 얻게 될 것이다. 이것은 공격자가 너의 전체 디스크를 지워버리거나 혹은 더 심각한 문제를 초래할 수 있다. 반면, 너의 서버가 정기 유저(regular user)의 인가로 실행된다면, 공격자는 이러한 인가들로 인해 제한을 받을 것이다.

<br/><br/>

### 블로그 인용: "너의 애플리케이션을 포트번호 80 또는 443에서 실행하고자 한다면, 너는 포트 포워딩(port forwarding)을 고려해봄직 하다."

[Deepal Jayasekara](https://jsblog.insiderattack.net/developing-secure-node-js-applications-a-broad-guide-286afdec69ce)이 개괄적으로 가이드한 '안전한 Node.js 애플리케이션 개발하기' 블로그로 부터:

> 절대로 Node.js를 루트로 실행하지 마라. node.js를 루트로 실행하는 것은 공격자가 애플리케이션에 대한 다소간 지배권을 얻는다면 상황을 악화시킬 것이다. 이 시나리오에선,공격자는 루트 우선권 또한 손에 넣을 수 있고, 이는 재앙으로 연결된다. 너의 애플리케이션을 포트번호 80 혹은 443으로 실행하고자 한다면, iptables를 이용한 port forawrd를 하거나, 포트번호 80 또는 443으로 부터 너의 애플리케이션에 들어오는 요청을 라우팅할 수 있는 nginx 또는 apache같은 프론트엔드 프록시를 배치하는 방법이 있다.
